---
title: "USYD Water Balance site-based"
author: "Niranjan Wimalathunge"
date: "6/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(message = FALSE)
#knitr::opts_chunk$set(warning = FALSE)
```

## Introduction
USYD soil water balance model (WBM), a process-based model, caters to soil water dynamics across multiple depth support and scalable farmscapes. The WBM is a multi-layer, knowledge-based model that better represents the vertical soil moisture variation. It is also an unsaturated model where water infiltrates through layers freely and continuously according to the soil properties, determined by the Soil Landscape Grid of Australia (SLGA). Its depth intervals are the model's layer thickness. The corresponding clay, sand and bulk density values were used to calculate the saturated volumetric moisture content (θs) using a pedotransfer function (PTF), which is developed by Padarian et al. (2014). 
The soil is assumed uniform within each horizontal layer, and the water flows through the soil layers vertically. Therefore, the infiltration continues for all layers, and excess soil water beyond the 60–100 cm layer is assumed to be deep drainage and lost to the system as the modelling depth is 1m (root zone). It is also assumed that runoff only occurs when Layer 0–5 cm and Layer 5–15 cm are saturated. Therefore, ET and rainfall required to downscale to 90 m to match with the SLGA resolution. The model is run on each SLGA raster cell daily with the corresponding value for rainfall and evapotranspiration (ET). ET is extracted from layers fully. First, ET is extracted from layer one, and if there a deficit, it is then taken from layer 2. If there still a deficit, it is then taken from the next layer and so on. This method mimics the general behaviour of water extraction by rooting systems of crops.

The model inputs are ET (MODIS 500 m), rainfall (SILO 5 km ) and soil (SLGA 90 m), which can be freely downloadable. This tutorial shows as an example to show how to estimate soil water of a point measurement at 0-100 cm depths of an area of interest.

### Getting Started
```{r}
# load required libraries
library(raster)
library(RCurl)
library(rgdal)
library(sp)
```

## Example: Muttama

### Get data
### use the bellow link
Use the [link](https://cloudstor.aarnet.edu.au/plus/s/xSz5iOx9fJmSyJ0) to download the datasets and change the file paths accordingly

Resolution: ET - 90 m, rain - 90 m and soil: 90 m. 
Duration: 01-01-2001 to 31-12-2020

### Area of interest (Mattuma catchment)
```{r}
#coordinates of required points

coord<-read.csv("X:/PRJ-SoilWaterNow/data/Farms&sites/Muttama/Muttama_baseline_coords.csv")[-c(1,5)]
coord <- coord[complete.cases(coord),]
coord1 <- data.frame(x=coord$Easting,y=coord$Northing) 
coordinates(coord1) <- ~x+y 
proj4string(coord1) <- CRS("+proj=utm +zone=55 +south +ellps=GRS80 +units=m +no_defs") 
coordLatlong <- spTransform(coord1,CRS("+proj=longlat +datum=WGS84 +no_defs"))
```
###covariates of the water balance

```{r}
rain<-brick("X:/PRJ-SoilWaterNow/data/Farms&sites/Muttama/NSWRain.tif")
ET<-brick("X:/PRJ-SoilWaterNow/data/Farms&sites/Muttama/MuttamaET2001_2020.tif")
########################################################
```
#### Bucket size using a pedotranfer function

```{r}


theta <- brick("X:/PRJ-SoilWaterNow/data/Farms&sites/Muttama/MuttamaSoil.tif")
names(theta)[1:20]<-c( "BDW_005","BDW_015","BDW_030","BDW_060","BDW_100",
                       "CLY_005","CLY_015","CLY_030","CLY_060","CLY_100", 
                       "SLT_005","SLT_015","SLT_030","SLT_060","SLT_100",
                       "SND_005","SND_015","SND_030","SND_060","SND_100")

theta_005 = 0.4795 - 3.873 * 10^-5 * theta$SND_005 ^2 - 6.701 * 10^-7 * theta$CLY_005 ^2 * theta$SND_005
theta_015 = 0.4795 - 3.873 * 10^-5 * theta$SND_015 ^2 - 6.701 * 10^-7 * theta$CLY_015 ^2 * theta$SND_015
theta_030 = 0.4795 - 3.873 * 10^-5 * theta$SND_030 ^2 - 6.701 * 10^-7 * theta$CLY_030 ^2 * theta$SND_030
theta_060 = 0.4795 - 3.873 * 10^-5 * theta$SND_060 ^2 - 6.701 * 10^-7 * theta$CLY_060 ^2 * theta$SND_060
theta_100 = 0.4795 - 3.873 * 10^-5 * theta$SND_100 ^2 - 6.701 * 10^-7 * theta$CLY_100 ^2 * theta$SND_100

bucketSize <-stack(theta_005*50,theta_015*100,theta_030*150,theta_060*300,theta_100*400)
names(bucketSize)[1:5]<-c("theta_005","theta_015","theta_030","theta_060","theta_100")

```

### extract values for the corrosponding xy coordinates
```{r}
ET<-data.frame(raster::extract(ET,coordLatlong@coords))
Rain<-data.frame(raster::extract(rain,coordLatlong@coords))
bucketSize<-data.frame(raster::extract(bucketSize,coordLatlong@coords))

```

## Water Balance

```{r}
result<- array(rep(1, 12*7305*dim(ET)[1]), dim=c(dim(ET)[1], 7305, 12))
result<- array(rep(1, 12*7305*6), dim=c(6, 7305, 12))

days <- seq(from=as.Date('2001-01-01'), to=as.Date("2020-12-31"),by='days' )
days <- seq(from=as.Date('2020-12-26'), to=as.Date("2020-12-31"),by='days' )

# 1- current day ; 2-previous day 
# For example, SMA1(0-5 cm) means  today's soil moisture for 0-5 cm layer whereas SMA2 is previous day soil moisture for 0-5 cm layer

Etd<-0 # dificit ET

for(i in seq_len(dim(result)[1])){
  a=1
  SM=0;SMA=c(0,0,0);SMB=c(0,0,0);SMC=c(0,0,0);SMD=c(0,0,0);SME=c(0,0,0);runoff=0; DeepD=0
  
  for(j in seq_len(dim(result)[2])){

  #bucket1    
    ETa<-ET[i,a]*0.125
    
    SMA[2]=SMA[1]*.8
    SMA[1]=SMA[1]*.2
    
    SMA[1] = SMA[1]+Rain[i,a]-ETa
    
    if (SMA[1] > 0){ETd=0}
    if (SMA[1] < 0){ETd=-(SMA[1]);SMA[1]=0}
    if (SMA[1] > bucketSize[i,1]){SMB[1]= SMB[1]+(SMA[1]-bucketSize[i,1]);SMA[1]=bucketSize[i,1];print('bucket a is full')}
    
  #bucket2
    
    SMB[2]=SMB[1]*.05
    SMB[1]=SMB[1]*.95
    
    SMB[1] = SMB[1]+SMA[2]-ETd
    
    if (SMB[1] > 0){ETd=0}
    if (SMB[1] < 0){ETd=-(SMB[1]);SMB[1]=0}
    #if (SMA[1]==bucketSize[i,1] & SMB[1]>bucketSize[i,2]){runoff= SMB[1]-bucketSize[i,2];print('buckets ab are full')}
    if (SMB[1]> bucketSize[i,2]){SMC[1]= SMC[1]+(SMB[1]-bucketSize[i,2]);SMB[1]=bucketSize[i,2];print('bucket b is full')}
    
  #bucket3
    SMC[2]=SMC[1]*.05
    SMC[1]=SMC[1]*.95
    
    SMC[1] = SMC[1]+SMB[2]-ETd
    
    if (SMC[1] > 0){ETd=0}
    if (SMC[1] < 0){ETd=-(SMC[1]);SMC[1]=0}
    if (SMC[1]> bucketSize[i,3]){SMD[1]= SMD[1]+(SMC[1]-bucketSize[i,3]);SMC[1]=bucketSize[i,3];print('smc is full')}
    
  #bucket4
    
    SMD[2]=SMD[1]*.01
    SMD[1]=SMD[1]*.99
    
    SMD[1] = SMD[1]+ SMC[2]-ETd
    
    if (SMD[1] > 0){ETd=0}
    if (SMD[1] < 0){ETd=-(SMD[1]);SMD[1]=0}
    if (SMD[1]> bucketSize[i,4]){SME[1]= SME[1]+(SMD[1]-bucketSize[i,4]);SMD[1]=bucketSize[i,4];print('smd is full')}
    
  #bucket5
    SME[2]=SME[1]*.01
    SME[1]=SME[1]*.99
    
    SME[1] = SME[1]+ SMD[2]-ETd
    
    if (SME[1] > 0){ETd=0}
    if (SME[1] < 0){ETd=-(SME[1]);SME[1]=0}
    if (SME[1]> bucketSize[i,5]){DeepD = (SME[1]-bucketSize[i,5]);SME[1]=bucketSize[i,5];print('sme is full')}
    
    DeepD = DeepD +SME[2]  #lost soil moisture (60-100cm(SME)) due to deep drainage
    SM30=SMA[1]+SMB[1]+SMC[1]
    SM100=SMA[1]+SMB[1]+SMC[1]+SMD[1]+SME[1]
    
    result[i,j,1] = as.character(days[j])
    result[i,j,2] = SM30
    result[i,j,3] = SM100
    result[i,j,4] = Rain[i,a]
    result[i,j,5] = ETa
    result[i,j,6] = Rain[i,a]-ETa
    result[i,j,7] = SMA[1] 
    result[i,j,8] = SMB[1]
    result[i,j,9] = SMC[1]
    result[i,j,10] = SMD[1]
    result[i,j,11] = SME[1]
    result[i,j,12] = DeepD
    
    runoff = 0
    DeepD = 0
    ETd = 0
    a=a+1
    print(a)
  }
 
  }
```
### save the output as csv

```{r}
for (i in 1:6){
  k=241
  out<-as.data.frame(result[i,,])
  colnames(out)[1:12]<- c("date", "SM30", "SM100","rain","ET","Delta","SM0-5","SM5-15","SM15-30","SM30-60","SM60-100","DeepD")
  write.table(out, file= paste("Cox_site",i,"csv",sep="."), sep=",",row.names=F, col.names=T)
  k=k+1
  }

```

















































